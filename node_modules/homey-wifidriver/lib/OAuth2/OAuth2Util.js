'use strict';

const Homey = require('homey');
const EventEmitter = require('events');

class OAuth2Util {
	static generateOAuth2Callback(oauth2Account, socket) {
		const eventEmitter = socket || new EventEmitter();
		new Homey.CloudOAuth2Callback(oauth2Account.getOAuth2Url())
			.once('url', url => {
				console.log('_generateOAuth2Callback() -> retrieved authentication url');
				eventEmitter.emit('url', url);
			})
			.once('code', code => {
				console.log('_generateOAuth2Callback() -> retrieved authentication code');

				// Fetch access tokens
				oauth2Account.getAccessTokens(code)
					.then(() => {
						console.log('_generateOAuth2Callback() -> successfully retrieved access tokens');
						eventEmitter.emit('authorized');
					})
					.catch(err => {
						console.error('_generateOAuth2Callback() error', err.stack);
						eventEmitter.emit('error', err);
					});
			})
			.generate();

		return eventEmitter;
	}
}

module.exports = OAuth2Util;
